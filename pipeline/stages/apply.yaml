parameters:
  - name: environments
    type: object
  - name: services
    type: object

stages:
    - ${{ each environment in parameters.environments }}:

      - stage: 'Apply_${{ variables.serviceName }}_${{ environment.name }}'
        ${{ if and(eq(environment.name, 'sbox'), ne(variables.serviceName, 'SharedServies')) }}:
          dependsOn: 'Wait_${{ variables.serviceName }}_${{ environment.name }}'
        ${{ if or(ne(environment.name, 'sbox'), eq(variables.serviceName, 'SharedServies')) }}:
          dependsOn: 'Wait_${{ variables.serviceName }}_${{ environment.name }}'
        displayName: Apply ${{ environment.name }} ${{ variables.serviceDisplayName}}
        pool:
          vmImage: 'ubuntu-latest'
        variables: 
          - template: ../variables/Shared.yaml
            parameters:
              environment: ${{ environment }}
          - template: ../variables/${{ variables.serviceName }}.yaml
            parameters:
              environment: ${{ environment }}

        jobs:
          - template: ../jobs/terraform-deploy.yaml
            parameters:
              displayName: "Deploy ${{ environment.name }} Shared Infra"
              subscription: ${{ environment.subscription }}
              environment: ${{ environment.name }}
              resourceGroup: $(resourceGroup)
              storageAccount: $(storageAccount)
              containerName: $(containerName)
              builtFrom: ${{ variables.builtFrom }}
              product: ${{ variables.product }}
              variables:
                resourceGroup: ${{ variables.resourceGroupName }}
                containerName: ${{ variables.containerName }}
                storageAccount: ${{ variables.storageAccount }}
              outputName: '${{ variables.planOutputName }}'
              workingDirectory: ${{ variables.workingDirectory }}
              serviceName: ${{ variables.serviceName }}

          - ${{ if eq(service.name,'SharedInfra') }}:
            - template: ../jobs/setup-azmonlink.yaml
              parameters:
                displayName: Set up Azure Monitor Link to Log Analytics
                dependsOn: TerraformDeploy
                subscription: ${{ environment.subscription }}
                environment: ${{ environment.name }}
                builtFrom: ${{ variables.builtFrom }}
                businessArea: ${{ variables.businessArea }}